name: ğŸš€ Version & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Type de version Ã  crÃ©er'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  version-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ·ï¸ Auto-increment version (push to main)
      if: github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # VÃ©rifier s'il y a des changements dans CHANGELOG [Non publiÃ©]
        if grep -q "### AjoutÃ©" CHANGELOG.md && grep -A 20 "## \[Non publiÃ©\]" CHANGELOG.md | grep -q -E "(- |âœ¨|ğŸ›|ğŸ”§|ğŸ›¡ï¸)"; then
          echo "ğŸ“ Changements dÃ©tectÃ©s dans CHANGELOG, crÃ©ation d'une version patch"
          npm run version:patch
          
          # Commit et push des changements de version
          git add package.json CHANGELOG.md src/components/admin/VersionInfo.tsx
          git commit -m "chore: bump version to v$(node -p "require('./package.json').version")"
          git push origin main
          
          # CrÃ©er et pousser le tag
          VERSION=$(node -p "require('./package.json').version")
          git tag "v$VERSION"
          git push origin --tags
        else
          echo "ğŸ“ Aucun changement significatif dÃ©tectÃ© dans CHANGELOG"
        fi

    - name: ğŸ·ï¸ Manual version increment (workflow_dispatch)
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        npm run version:${{ github.event.inputs.version_type }}
        
        # Commit et push des changements de version
        git add package.json CHANGELOG.md src/components/admin/VersionInfo.tsx
        git commit -m "chore: bump version to v$(node -p "require('./package.json').version")"
        git push origin main
        
        # CrÃ©er et pousser le tag
        VERSION=$(node -p "require('./package.json').version")
        git tag "v$VERSION"
        git push origin --tags

    - name: âœ… Version updated successfully
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "ğŸ‰ Version v$VERSION crÃ©Ã©e avec succÃ¨s!"
        echo "ğŸš€ DÃ©clenchement du dÃ©ploiement GitHub Pages..."

  deploy:
    needs: version-and-deploy
    uses: ./.github/workflows/deploy-pages.yml
    permissions:
      contents: read
      pages: write
      id-token: write
