name: ğŸš€ Version & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Type de version Ã  crÃ©er'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  version-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ·ï¸ Auto-increment version (push to main)
      if: github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # VÃ©rifier s'il y a des changements dans CHANGELOG [Non publiÃ©]
        if grep -q "### AjoutÃ©" CHANGELOG.md && grep -A 20 "## \[Non publiÃ©\]" CHANGELOG.md | grep -q -E "(- |âœ¨|ğŸ›|ğŸ”§|ğŸ›¡ï¸)"; then
          echo "ğŸ“ Changements dÃ©tectÃ©s dans CHANGELOG, crÃ©ation d'une version patch"
          npm run version:patch
          
          # Commit et push des changements de version
          git add package.json CHANGELOG.md
          git commit -m "chore: bump version to v$(node -p "require('./package.json').version")"
          git push
          
          # CrÃ©er et pousser le tag
          VERSION=$(node -p "require('./package.json').version")
          git tag "v$VERSION"
          git push --tags
        else
          echo "ğŸ“ Aucun changement significatif dÃ©tectÃ© dans CHANGELOG"
        fi

    - name: ğŸ·ï¸ Manual version increment (workflow_dispatch)
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        npm run version:${{ github.event.inputs.version_type }}
        
        # Commit et push des changements de version
        git add package.json CHANGELOG.md
        git commit -m "chore: bump version to v$(node -p "require('./package.json').version")"
        git push
        
        # CrÃ©er et pousser le tag
        VERSION=$(node -p "require('./package.json').version")
        git tag "v$VERSION"
        git push --tags

    - name: ğŸ”¨ Build application
      run: npm run build

    - name: ğŸ“„ Setup Pages
      uses: actions/configure-pages@v4

    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'

    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: ğŸ“Š Display version info
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "ğŸ‰ DÃ©ployÃ© avec succÃ¨s!"
        echo "ğŸ“¦ Version: v$VERSION"
        echo "ğŸŒ URL: https://collectifilefeydeau.github.io/1Hall1Artiste/"
        echo "ğŸ“… Date: $(date)"
